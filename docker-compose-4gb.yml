services:
  # 训练服务 - 4GB内存优化配置
  train:
    image: chatglm-cpu-trainer
    container_name: chatglm-train
    volumes:
      - ./data:/app/data
      - ./models:/app/models
    environment:
      - OMP_NUM_THREADS=2
      - MKL_NUM_THREADS=2
      - HF_ENDPOINT=https://hf-mirror.com
      - PYTHONPATH=/app
    command: python -m app.train 
              --model_name_or_path THUDM/chatglm2-6b 
              --dataset_path /app/data/input/dataset.txt 
              --output_dir /app/models/chatglm-lora
              --quantization 4bit
              --max_seq_length 32
              --max_samples 30
              --lora_r 4
              --per_device_train_batch_size 1
              --gradient_accumulation_steps 32
              --learning_rate 5e-5
              --num_train_epochs 3
    deploy:
      resources:
        limits:
          memory: 3.8G
    restart: "no"

  # 预测服务
  predict:
    image: chatglm-cpu-trainer
    container_name: chatglm-predict
    volumes:
      - ./data:/app/data
      - ./models:/app/models
    environment:
      - OMP_NUM_THREADS=2
      - MKL_NUM_THREADS=2
      - HF_ENDPOINT=https://hf-mirror.com
      - PYTHONPATH=/app
    command: python -m app.predict
              --model_path /app/models/chatglm-lora
              --base_model_path THUDM/chatglm2-6b
              --quantization 4bit
              --prompt "请介绍一下人工智能的发展历史。"
    deploy:
      resources:
        limits:
          memory: 3.8G
    restart: "no"